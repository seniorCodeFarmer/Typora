## 3、基本的`SELECT`语句



## 1、`SQL`概述

### 1.1、`SQL`背景知识

- `1946`年，世界上第一台电脑诞生，如今，借由这台电脑发展起来的互联网已经自成江湖。在这几十年里，无数的技术、产业在这片江湖里沉浮，有的方兴未艾，有的已经几幕兴衰。但在这片浩荡的波动里，有一门技术从未消失，甚至“老当益壮”，那就是`SQL`。
  - `45`年前，也就是`1974`年，`IBM`研究员发布了一篇揭开数据库技术的论文《`SEQUEL`：一门结构化的英语查询语言》，直到今天这门结构化的查询语言并没有太大的变化，相比于其他语言，`SQL`的半衰期可以说是非常长了。
- 不论是前端工程师，还是后端算法工程师，都一定会和数据打交道，都需要了解如何又快又准确地提取自己想要的数据。更别提数据分析师了，他们的工作就是和数据打交道，整理不同的报告，以便指导业务决策。

- `SQL`（`Structured Query Language`，结构化查询语言）是使用关系模型的数据库应用语言， 与数据直接打交道 ，由`IBM`上世纪`70`年代开发出来。后由美国国家标准局（`ANSI`）开始着手制定`SQL`标准，先后有`SQL-86、SQL-89、SQL-92、SQL-99`等标准。
  - `SQL`有两个重要的标准，分别是`SQL92`和`SQL99`，它们分别代表了`92`年和`99`年颁布的`SQL`标准，我们今天使用的`SQL`语言依然遵循这些标准。
- 不同的数据库生产厂商都支持`SQL`语句，但都有特有内容。


![image-20230803010948831](https://zcw-typora.oss-cn-nanjing.aliyuncs.com/image-20230803010948831.png)



### 1.2、`SQL`分类

- `SQL`在功能上主要分为如下`3`大类：

  - `DDL`（`Data Definition Languages`数据定义语言）：这些语句定义了不同的数据库、表、视图、索引等数据库对象，还可以用来创建、删除、修改数据库和数据表的结构。主要的语句关键词包括：`CREAT、DROP、ALTER`等。


  - `DML`（`Data Manipulation Language`数据操作语句）：用于添加、删除、更新和查询数据库记录，并检查数据完整性，主要的语句关键字包括：`INSERT、DELETE、UPDATE、SELECT`等。

  - `DCL`（`Data Control Language`数据控制语言）：用于定义数据库、表、字段、用户的访问权限和安全级别。主要的语句关键字包括：`GRANT、REVOKE、COMMIT、ROLLBACK、SAVEPOINT`等。




## 2、`SQL`语言的规则与规范

### 2.1、基本规则

- `SQL`可以写在一行或者多行。为了提高可读性，各子句分行写，必要时使用缩进。
- 每条命令以；或`/g、/G`结束。
- 关键字不能被缩写也不能分行。
- 关于标点符号。
  - 字符串型和日期时间类型的数据可以使用单引号`'`表示。
  - 列的别名，尽量使用双引号`" "`，而且不建议省略`as`。



### 2.2、`SQL`大小写规范

- `MySQL`在`Windows`环境下是大小写不敏感的。

- `MySQL`在`Linux`环境下是大小写敏感的。
  - 数据库名、表名、表的别名、变量名是严格区分大小写的。
  - 关键字、函数名、列名（或字段名）、列的别名（字段的别名）是忽略大小写的。

- 推荐采用统一的书写规范。
  - 数据库名、表名、表别名、字段名、字段别名都用小写。
  - `SQL`关键字、函数名、绑定变量等都大写。




### 2.3、注释

### 2.4、命名规则

- 数据库、表名不得超过`30`个字符，变量名限制为`29`个。
- 必须只能包含`A–Z, a–z, 0–9, _`共`63`个字符。
- 数据库名、表名、字段名等对象名中间不要包含空格。
- 同一个`MySQL`软件中，数据库不能同名；同一个库中，表不能重名；同一个表中，字段不能重名。
- 必须保证你的字段没有和保留字、数据库系统或常用方法冲突。如果坚持使用，请在`SQL`语句中使用`  ` `（着重号）引起来。
- 保持字段名和类型的一致性，在命名字段并为其指定数据类型的时候一定要保证一致性。假如数据类型在一个表里是整数，那在另一个表里可就别变成字符型了。



### 2.5、数据导入命令

```sql
mysql> source d:\mysqldb.sql
```



## 3、基本的`SELECT`语句

### 3.1、`SELECT * FROM`

- 一般情况下，除非需要使用表中的所有字段数据，最好不要使用通配符`*`。使用通配符虽然可以节省输入查询语句的时间，但是获取不需要的列数据通常会减低查询和所使用的应用程序的效率。通配符的优势是，当不知道所需要的列的名称时，可以通过它获取它们。
- 在生产环境下，不推荐你直接使用`SELECT * `进行查询



### 3.2、列的别名

- `AS(alias)`，可以省略，但不建议省略。
- 紧跟列名，也可以在列名和别名之间加入关键字`AS`，别名使用双引号，以便在别名中包含空格或特殊的字符并区分大小写。
- 列的别名可以使用一对双引号，不要使用单引号。

```sql
SELECT last_name AS "name", commission_pct comm FROM employees;
```



### 3.3、去除重复行

- 在`SELECT`语句中使用关键字`DISTINCT`去除重复行。


```sql
SELECT DISTINCT department_id FROM employees;
```

- 针对于下列代码有两点需要注意：

  - `DISTINCT`需要放到所有列名的前面，如果写成`SELECT salary,DISTINCT department_id FROM employees`会报错。

  - `DISTINCT`其实是对后面所有列名的组合进行去重，你能看到最后的结果是`74`条，因为这`74`个部门`id`不同，都有`salary`这个属性值。如果你想要看都有哪些不同的部门（`department_id`），只需要写`DISTINCT department_id`即可，后面不需要再加其他的列名了。


~~~sql
SELECT DISTINCT department_id FROM employees;
~~~



### 3.5、空值参与运算

- 所有运算符或列值遇到`null`值，运算的结果都为`null`。


~~~sql
SELECT employee_id,salary,commission_pct, 12 * salary * (1 + commission_pct) AS "annual_sal" FROM employees;
~~~

- 这里你一定要注意，在`MySQL`里面， 空值不等于空字符串。一个空字符串的长度是`0`，而一个空值的长度是空。而且，在`MySQL`里面，空值是占用空间的。




### 3.6、着重号

- 错误的：


~~~sql
mysql> SELECT * FROM ORDER; 
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ORDER' at line 1
~~~

- 正确的：


~~~sql
mysql> SELECT * FROM `ORDER`;
~~~

- 我们需要保证表中的字段、表名等没有保留字、数据库系统或常用方法名冲突。如果真的相同，请在`SQL`语句中使用一对` `` `（单引号）引起来。




### 3.7、查询常数

- `SELECT`查询还可以对常数进行查询。对的，就是在`SELECT`查询结果中增加一列固定的常数列。这列的取值是我们指定的，而不是从数据表中动态取出的。
- 你可能会问为什么我们还要对常数进行查询呢？

  - `SQL`中的`SELECT`语法的确提供了这个功能，一般来说我们只从一个表中查询数据，通常不需要增加一个固定的常数列，但如果我们想整合不同的数据源，用常数列作为这个表的标记，就需要查询常数。
  - 比如说，我们想对 employees 数据表中的员工姓名进行查询，同时增加一列字段`corporation`，这个字段固定值为“尚硅谷”，可以这样写：

~~~sql 
SELECT '尚硅谷' AS corporation, last_name FROM employees;
~~~



## 4、显示表的结构

### 4.1、使用 `DESCRIBE`或`DESC `命令，表示表结构

~~~sql
DESCRIBE employees;
或
DESC employees;
~~~



### 4.2、各字段含义

- `Field`：表示字段名称。
- `Type`：表示字段类型，这里`barcode、goodsname`是文本型的，`price`是整数类型的。
- `Null`：表示该列是否可以存储`NULL`值。
- `Key`：表示该列是否已编制索引。`PRI`表示该列是表主键的一部分；`UNI`表示该列是`UNIQUE`索引的一部分；`MUL`表示在列中某个给定值允许出现多次。
- `Default`：表示该列是否有默认值，如果有，那么值是多少。
- `Extra`：表示可以获取的与给定列有关的附加信息，例如`AUTO_INCREMENT`等。





## 5、`SELECT`的执行过程

### 5.1、查询的结构

```sql
#方式1：
SELECT ...,....,...
FROM ...,...,....
WHERE 多表的连接条件 AND 不包含组函数的过滤条件
GROUP BY ...,...
HAVING 包含组函数的过滤条件
ORDER BY ... ASC/DESC
LIMIT ...,...

#方式2：
SELECT ...,....,...
FROM ...JOIN ...
ON 多表的连接条件
JOIN ...
ON ...
WHERE 不包含组函数的过滤条件
AND/OR 不包含组函数的过滤条件
GROUP BY ...,...
HAVING 包含组函数的过滤条件
ORDER BY ... ASC/DESC
LIMIT ...,...
```



### 5.2、`SELECT`执行顺序

- 关键字的顺序是不能颠倒的。
- SELECT语句的执行顺序：

~~~
FROM -> WHERE -> GROUP BY -> HAVING -> SELECT 的字段 -> DISTINCT -> ORDER BY -> LIMIT
~~~

~~~sql
SELECT DISTINCT player_id, player_name, count(*) as num # 顺序 5
FROM player JOIN team ON player.team_id = team.team_id # 顺序 1
WHERE height > 1.80 # 顺序 2
GROUP BY player.team_id # 顺序 3
HAVING num > 2 # 顺序 4
ORDER BY num DESC # 顺序 6
LIMIT 2 # 顺序 7
~~~

- 在`SELECT`语句执行这些步骤的时候，每个步骤都会产生一个虚拟表 ，然后将这个虚拟表传入下一个步骤中作为输入。需要注意的是，这些步骤隐含在`SQL`的执行过程中，对于我们来说是不可见的。



### 5.3、SQL 的执行原理

- `SELECT`是先执行`FROM`这一步的。在这个阶段，如果是多张表联查，还会经历下面的几个步骤： 

- - 首先先通过`CROSS JOIN`求笛卡尔积，相当于得到虚拟表`vt(virtual table)1-1`；
  - 通过`ON`进行筛选，在虚拟表`vt1-1`的基础上进行筛选，得到虚拟表`vt1-2`；
  - 添加外部行。如果我们使用的是左连接、右链接或者全连接，就会涉及到外部行，也就是在虚拟表`vt1-2`的基础上增加外部行，得到虚拟表`vt1-3`。

- 当然如果我们操作的是两张以上的表，还会重复上面的步骤，直到所有表都被处理完为止。这个过程得到是我们的原始数据。

- 当我们拿到了查询数据表的原始数据，也就是最终的虚拟表`vt1`，就可以在此基础上再进行`WHERE`阶段 。在这个阶段中，会根据`vt1`表的结果进行筛选过滤，得到虚拟表`vt2`。

- 然后进入第三步和第四步，也就是`GROUP`和`HAVING`阶段 。在这个阶段中，实际上是在虚拟表`vt2`的基础上进行分组和分组过滤，得到中间的虚拟表`vt3`和`vt4`。

- 当我们完成了条件筛选部分之后，就可以筛选表中提取的字段，也就是进入到`SELECT`和`DISTINCT`阶段 。

- - 首先在`SELECT`阶段会提取想要的字段，然后在`DISTINCT`阶段过滤掉重复的行，分别得到中间的虚拟表`vt5-1` 和 `vt5-2`。
  - 当我们提取了想要的字段数据之后，就可以按照指定的字段进行排序，也就是`ORDER BY`阶段 ，得到虚拟表`vt6`。
  - 最后在`vt6`的基础上，取出指定行的记录，也就是`LIMIT`阶段 ，得到最终的结果，对应的是虚拟表`vt7`。

- 当然我们在写`SELECT`语句的时候，不一定存在所有的关键字，相应的阶段就会省略。同时因为`SQL`是一门类似英语的结构化查询语言，所以我们在写`SELECT`语句的时候，还要注意相应的关键字顺序，所谓底层运行的原理，就是我们刚才讲到的执行顺序。















